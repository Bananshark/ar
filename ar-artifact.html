<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ARæ–‡ç‰©ä»‹ç»ç³»ç»Ÿ</title>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.min.js"></script>
    
    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* é¢œè‰²ç³»ç»Ÿ */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-gold: #d4af37;
            --accent-bronze: #cd7f32;
            --primary: #6e8efb;
            --primary-gradient: linear-gradient(135deg, #6e8efb, #a777e3);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            
            /* é—´è· */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            
            /* åœ†è§’ */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            z-index: 100;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            background: var(--primary-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: var(--space-4);
        }

        .nav-btn {
            padding: var(--space-2) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--primary-gradient);
            border-color: transparent;
        }

        /* ARè§†å›¾å®¹å™¨ */
        #ar-container {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: calc(100vh - 64px);
            overflow: hidden;
        }

        #ar-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* æ–‡ç‰©ä¿¡æ¯å¡ç‰‡ */
        .artifact-info-card {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            width: 360px;
            max-height: 500px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: none;
            animation: slideUp 0.4s ease;
            overflow-y: auto;
        }

        .artifact-info-card.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .artifact-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .artifact-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            border: 2px solid var(--accent-gold);
        }

        .artifact-title {
            flex: 1;
        }

        .artifact-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--accent-gold);
        }

        .artifact-dynasty {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .artifact-description {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }

        .artifact-details {
            margin-top: var(--space-4);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-3) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .detail-label {
            color: var(--text-tertiary);
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .expand-btn {
            margin-top: var(--space-4);
            width: 100%;
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* AIèŠå¤©é¢æ¿ */
        .chat-panel {
            position: fixed;
            bottom: var(--space-6);
            left: var(--space-6);
            width: 400px;
            max-height: 500px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: none;
            flex-direction: column;
        }

        .chat-panel.active {
            display: flex;
        }

        .chat-header {
            padding: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            min-height: 200px;
            max-height: 300px;
        }

        .message {
            max-width: 80%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-self: flex-end;
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bot {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: var(--space-3);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(110, 142, 251, 0.2);
        }

        .chat-send {
            padding: var(--space-3) var(--space-5);
            background: var(--primary-gradient);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(110, 142, 251, 0.4);
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* èŠå¤©æŒ‰é’®ï¼ˆæµ®åŠ¨ï¼‰ */
        .chat-toggle {
            position: fixed;
            bottom: var(--space-6);
            left: var(--space-6);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(110, 142, 251, 0.4);
            z-index: 50;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(110, 142, 251, 0.5);
        }

        .chat-toggle.hidden {
            display: none;
        }

        /* çŠ¶æ€æç¤º */
        .status-overlay {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 60;
            display: none;
            align-items: center;
            gap: var(--space-3);
        }

        .status-overlay.active {
            display: flex;
        }

        .status-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .top-nav {
                height: 56px;
                padding: 0 var(--space-4);
            }

            #ar-container {
                top: 56px;
                height: calc(100vh - 56px);
            }

            .artifact-info-card {
                width: calc(100% - var(--space-4) * 2);
                right: var(--space-4);
                bottom: var(--space-4);
                max-height: 40vh;
            }

            .chat-panel {
                width: calc(100% - var(--space-4) * 2);
                left: var(--space-4);
                bottom: var(--space-4);
                max-height: 50vh;
            }

            .chat-toggle {
                bottom: var(--space-4);
                left: var(--space-4);
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .artifact-info-card::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .artifact-info-card::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .artifact-info-card::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        /* æ¨¡å‹èœå• */
        .model-menu {
            position: fixed;
            top: 80px;
            right: var(--space-6);
            width: 320px;
            max-height: 60vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .model-menu.active {
            display: flex;
        }

        .model-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .model-menu-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .model-menu-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .model-menu-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .model-menu-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .model-menu-item {
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .model-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-gold);
            transform: translateX(-4px);
        }

        .model-menu-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--accent-gold);
        }

        .model-menu-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .model-menu-info {
            flex: 1;
        }

        .model-menu-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .model-menu-dynasty {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .model-menu-btn {
            position: fixed;
            top: 80px;
            right: var(--space-6);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(110, 142, 251, 0.4);
            z-index: 49;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(110, 142, 251, 0.5);
        }

        .model-menu-btn.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .model-menu {
                width: calc(100% - var(--space-4) * 2);
                right: var(--space-4);
                top: 70px;
                max-height: 50vh;
            }

            .model-menu-btn {
                right: var(--space-4);
                top: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="logo">ğŸ›ï¸ ARæ–‡ç‰©ä»‹ç»</div>
        <div class="nav-buttons">
            <button class="nav-btn active" id="arModeBtn">ARæ¨¡å¼</button>
            <button class="nav-btn" id="collectionBtn">æ–‡ç‰©åº“</button>
            <button class="nav-btn" id="settingsBtn">è®¾ç½®</button>
        </div>
    </nav>

    <!-- ARè§†å›¾å®¹å™¨ -->
    <div id="ar-container">
        <video id="ar-video" autoplay playsinline></video>
        <canvas id="ar-canvas"></canvas>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="status-overlay" id="statusOverlay">
        <div class="loading-spinner"></div>
        <div class="status-text" id="statusText">æ­£åœ¨åˆå§‹åŒ–AR...</div>
    </div>

    <!-- æ–‡ç‰©ä¿¡æ¯å¡ç‰‡ -->
    <div class="artifact-info-card" id="artifactCard">
        <div class="artifact-header">
            <img class="artifact-thumbnail" id="artifactThumbnail" src="" alt="">
            <div class="artifact-title">
                <div class="artifact-name" id="artifactName">æ–‡ç‰©åç§°</div>
                <div class="artifact-dynasty" id="artifactDynasty">æœä»£</div>
            </div>
        </div>
        <div class="artifact-description" id="artifactDescription">æ–‡ç‰©ç®€ä»‹...</div>
        <div class="artifact-details" id="artifactDetails"></div>
        <button class="expand-btn" id="expandBtn">æŸ¥çœ‹è¯¦æƒ…</button>
    </div>

    <!-- AIèŠå¤©é¢æ¿ -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="chat-title">ğŸ’¬ AIæ–‡ç‰©åŠ©æ‰‹</div>
            <button class="chat-close" id="chatClose">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message message-bot">ä½ å¥½ï¼æˆ‘æ˜¯AIæ–‡ç‰©åŠ©æ‰‹ï¼Œå¯ä»¥é—®æˆ‘å…³äºæ–‡ç‰©çš„ä»»ä½•é—®é¢˜ã€‚</div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
            <button class="chat-send" id="chatSend">å‘é€</button>
        </div>
    </div>

    <!-- æ¨¡å‹èœå•æŒ‰é’® -->
    <button class="model-menu-btn" id="modelMenuBtn" title="æ¨¡å‹èœå•">ğŸ“¦</button>

    <!-- æ¨¡å‹èœå• -->
    <div class="model-menu" id="modelMenu">
        <div class="model-menu-header">
            <div class="model-menu-title">æ¨¡å‹é€‰æ‹©</div>
            <button class="model-menu-close" id="modelMenuClose">Ã—</button>
        </div>
        <div class="model-menu-list" id="modelMenuList">
            <!-- æ¨¡å‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- èŠå¤©æŒ‰é’®ï¼ˆæµ®åŠ¨ï¼‰ -->
    <button class="chat-toggle" id="chatToggle">ğŸ’¬</button>

    <script>
        // ========== é…ç½®å¸¸é‡ ==========
        const IS_DEV = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const DEBUG = IS_DEV; // å¼€å‘æ¨¡å¼å¯ç”¨è°ƒè¯•æ—¥å¿—

        // ========== å·¥å…·å‡½æ•° ==========
        const utils = {
            log: (...args) => DEBUG && console.log(...args),
            warn: (...args) => DEBUG && console.warn(...args),
            error: (...args) => console.error(...args),
            
            // é˜²æŠ–å‡½æ•°
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // èŠ‚æµå‡½æ•°
            throttle: (func, limit) => {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
        };

        // ========== å…¨å±€å˜é‡ ==========
        let mindarThree = null;
        let renderer = null;
        let scene = null;
        let camera = null;
        let currentArtifact = null;
        let currentModel = null;
        let appConfig = null;
        let apiConfig = {
            url: "",
            key: "",
            appId: ""
        };
        let artifacts = [];
        let animationId = null; // åŠ¨ç”»å¾ªç¯ID
        let isLoading = false; // APIè°ƒç”¨çŠ¶æ€
        let mixer = null; // åŠ¨ç”»æ··åˆå™¨

        // ========== DOMå…ƒç´ ç¼“å­˜ ==========
        const elements = {
            get statusOverlay() { return document.getElementById('statusOverlay'); },
            get statusText() { return document.getElementById('statusText'); },
            get artifactCard() { return document.getElementById('artifactCard'); },
            get chatPanel() { return document.getElementById('chatPanel'); },
            get chatToggle() { return document.getElementById('chatToggle'); },
            get chatMessages() { return document.getElementById('chatMessages'); },
            get chatInput() { return document.getElementById('chatInput'); },
            get chatSend() { return document.getElementById('chatSend'); },
            get arContainer() { return document.getElementById('ar-container'); },
            get arVideo() { return document.getElementById('ar-video'); },
            get arCanvas() { return document.getElementById('ar-canvas'); }
        };

        // ========== åŠ è½½é…ç½®æ–‡ä»¶ ==========
        async function loadConfig() {
            try {
                const response = await fetch('ar-config.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                appConfig = await response.json();
                utils.log('é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ', appConfig);
                
                // åº”ç”¨APIé…ç½®
                if (appConfig?.api) {
                    apiConfig = {
                        url: appConfig.api.url || "",
                        key: appConfig.api.key || "",
                        appId: appConfig.api.appId || ""
                    };
                }
                
                // åº”ç”¨æ–‡ç‰©æ•°æ®
                if (appConfig?.artifacts?.length > 0) {
                    artifacts = appConfig.artifacts;
                }
                
                return appConfig;
            } catch (error) {
                utils.warn('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
                // ä½¿ç”¨é»˜è®¤é…ç½®
                artifacts = [{
                    id: 1,
                    name: "ç¤ºä¾‹æ–‡ç‰©",
                    dynasty: "ç¤ºä¾‹æœä»£",
                    material: "ç¤ºä¾‹æè´¨",
                    size: "ç¤ºä¾‹å°ºå¯¸",
                    description: "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡ç‰©",
                    modelUrl: "model/kid-hello.glb",
                    thumbnailUrl: "https://via.placeholder.com/200",
                    markerImageIndex: 0
                }];
                return null;
            }
        }

        // ========== åˆ›å»ºåœºæ™¯å’Œç¯å…‰ ==========
        function createSceneLights() {
            if (!scene) return;
            
            // æ·»åŠ ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // æ·»åŠ å®šå‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);
        }

        // ========== æµ‹è¯•æ¨¡å¼ï¼šç›´æ¥åŠ è½½æ¨¡å‹ ==========
        function initTestMode() {
            try {
                updateStatus("æµ‹è¯•æ¨¡å¼ï¼šæ­£åœ¨åŠ è½½3Dåœºæ™¯...");
                
                // åˆ›å»ºThree.jsåœºæ™¯
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0f172a);
                
                // åˆ›å»ºç›¸æœº
                const container = elements.arContainer;
                const aspect = container.clientWidth / container.clientHeight;
                camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
                camera.position.set(0, 1.5, 5);
                
                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ 
                    canvas: elements.arCanvas,
                    antialias: true,
                    powerPreference: "high-performance"
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                // æ·»åŠ ç¯å…‰
                createSceneLights();
                
                // åŠ è½½ç¬¬ä¸€ä¸ªæ–‡ç‰©è¿›è¡Œæµ‹è¯•
                if (artifacts.length > 0) {
                    loadArtifact(artifacts[0]);
                }
                
                // å¯åŠ¨æ¸²æŸ“å¾ªç¯
                const clock = new THREE.Clock();
                function animate() {
                    animationId = requestAnimationFrame(animate);
                    
                    const delta = clock.getDelta();
                    
                    // æ›´æ–°åŠ¨ç”»æ··åˆå™¨
                    if (mixer) {
                        mixer.update(delta);
                    }
                    
                    // æ¨¡å‹æ—‹è½¬ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
                    if (currentModel && !mindarThree) {
                        currentModel.rotation.y += 0.01;
                    }
                    
                    renderer.render(scene, camera);
                }
                animate();
                
                // çª—å£å¤§å°è°ƒæ•´
                const handleResize = utils.throttle(() => {
                    if (!camera || !renderer || !container) return;
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }, 100);
                window.addEventListener('resize', handleResize);
                
                updateStatus("æµ‹è¯•æ¨¡å¼å·²å¯åŠ¨ï¼Œæ¨¡å‹å·²åŠ è½½");
                setTimeout(() => hideStatus(), 2000);
                
            } catch (error) {
                utils.error('æµ‹è¯•æ¨¡å¼åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus("æµ‹è¯•æ¨¡å¼åˆå§‹åŒ–å¤±è´¥: " + error.message);
            }
        }

        // ========== ARåˆå§‹åŒ– ==========
        async function initAR() {
            try {
                updateStatus("æ­£åœ¨åˆå§‹åŒ–ARç³»ç»Ÿ...");
                
                // æ£€æŸ¥MindARåº“æ˜¯å¦åŠ è½½
                if (typeof MindARThree === 'undefined') {
                    throw new Error('MindARåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDN');
                }
                
                // æ£€æŸ¥å®¹å™¨å…ƒç´ 
                const container = elements.arContainer;
                if (!container) {
                    throw new Error('ARå®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
                }
                
                // è¯·æ±‚æ‘„åƒå¤´æƒé™
                let stream;
                try {
                    // é¦–å…ˆå°è¯•åç½®æ‘„åƒå¤´
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                } catch (camError) {
                    utils.warn('åç½®æ‘„åƒå¤´è·å–å¤±è´¥ï¼Œå°è¯•å‰ç½®æ‘„åƒå¤´:', camError);
                    try {
                        // å¦‚æœåç½®æ‘„åƒå¤´å¤±è´¥ï¼Œå°è¯•å‰ç½®æ‘„åƒå¤´
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'user',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            } 
                        });
                    } catch (userCamError) {
                        // å¦‚æœå‰ç½®æ‘„åƒå¤´ä¹Ÿå¤±è´¥ï¼Œå°è¯•ä¸æŒ‡å®šfacingMode
                        utils.warn('å‰ç½®æ‘„åƒå¤´è·å–å¤±è´¥ï¼Œå°è¯•é»˜è®¤æ‘„åƒå¤´:', userCamError);
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            } 
                        });
                    }
                }
                
                const video = elements.arVideo;
                if (!video) {
                    throw new Error('è§†é¢‘å…ƒç´ æœªæ‰¾åˆ°');
                }
                
                // è®¾ç½®è§†é¢‘æµ
                video.srcObject = stream;
                
                // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    video.onerror = reject;
                });

                // è·å–ARé…ç½®
                const arConfig = appConfig?.ar || {};
                const imageTargetSrc = arConfig.imageTargetSrc || 'targets/targets.mind';
                const maxTrack = arConfig.maxTrack || 1;

                // æ£€æŸ¥è¯†åˆ«å›¾æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆå¯é€‰ï¼Œä¸é˜»å¡åˆå§‹åŒ–ï¼‰
                try {
                    const checkResponse = await fetch(imageTargetSrc, { method: 'HEAD' });
                    if (!checkResponse.ok) {
                        utils.warn(`è¯†åˆ«å›¾æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨: ${imageTargetSrc}`);
                    }
                } catch (fetchError) {
                    utils.warn('è¯†åˆ«å›¾æ–‡ä»¶æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­åˆå§‹åŒ–:', fetchError);
                }

                // åˆå§‹åŒ–MindAR
                mindarThree = new MindARThree.MindARThree({
                    container: container,
                    imageTargetSrc: imageTargetSrc,
                    maxTrack: maxTrack,
                    uiLoading: 'no',
                    uiScanning: 'no',
                    uiError: 'no'
                });

                const { renderer: arRenderer, scene: arScene, camera: arCamera } = mindarThree;
                if (!arRenderer || !arScene || !arCamera) {
                    throw new Error('MindARåˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•è·å–æ¸²æŸ“å™¨ã€åœºæ™¯æˆ–ç›¸æœº');
                }
                
                renderer = arRenderer;
                scene = arScene;
                camera = arCamera;

                // æ·»åŠ ç¯å…‰
                createSceneLights();

                // å¯åŠ¨ARï¼ˆå¢åŠ è¶…æ—¶å¤„ç†ï¼‰
                const startPromise = mindarThree.start();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ARå¯åŠ¨è¶…æ—¶')), 10000)
                );
                
                await Promise.race([startPromise, timeoutPromise]);
                
                updateStatus("ARç³»ç»Ÿå·²å¯åŠ¨ï¼Œè¯·å°†æ‘„åƒå¤´å¯¹å‡†è¯†åˆ«å›¾");

                // ç›‘å¬è¯†åˆ«äº‹ä»¶
                mindarThree.onTargetFound = (targetIndex) => {
                    utils.log('è¯†åˆ«åˆ°ç›®æ ‡:', targetIndex);
                    // æ ¹æ®markerImageIndexæŸ¥æ‰¾å¯¹åº”çš„æ–‡ç‰©
                    const artifact = artifacts.find(a => a.markerImageIndex === targetIndex) || artifacts[targetIndex];
                    if (artifact) {
                        loadArtifact(artifact);
                    } else {
                        utils.warn('æœªæ‰¾åˆ°å¯¹åº”çš„æ–‡ç‰©ï¼Œç´¢å¼•:', targetIndex);
                    }
                };

                mindarThree.onTargetLost = () => {
                    utils.log('å¤±å»ç›®æ ‡');
                    hideArtifactCard();
                };

                // éšè—çŠ¶æ€æç¤º
                setTimeout(() => hideStatus(), 2000);

            } catch (error) {
                utils.error('ARåˆå§‹åŒ–å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼:', error);
                updateStatus(`ARåˆå§‹åŒ–å¤±è´¥: ${error.message}ï¼Œåˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼...`);
                
                // æ¸…ç†èµ„æº
                if (mindarThree) {
                    try {
                        mindarThree.stop();
                    } catch (e) {
                        utils.warn('åœæ­¢ARå¤±è´¥:', e);
                    }
                    mindarThree = null;
                }
                
                setTimeout(() => initTestMode(), 1000);
            }
        }

        // ========== åŠ è½½æ–‡ç‰© ==========
        function loadArtifact(artifact) {
            if (!artifact) return;

            currentArtifact = artifact;

            // æ˜¾ç¤ºæ–‡ç‰©ä¿¡æ¯å¡ç‰‡
            showArtifactCard(artifact);

            // åŠ è½½3Dæ¨¡å‹
            if (artifact.modelUrl) {
                loadModel(artifact.modelUrl);
            }
        }

        // ========== åŠ è½½3Dæ¨¡å‹ ==========
        function loadModel(url) {
            if (!scene) {
                utils.error('åœºæ™¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ¨¡å‹');
                return;
            }

            const loader = new THREE.GLTFLoader();
            
            // é…ç½®DracoåŠ è½½å™¨ï¼ˆå¦‚æœä½¿ç”¨å‹ç¼©æ¨¡å‹ï¼‰
            try {
                const dracoLoader = new THREE.DRACOLoader();
                dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
                loader.setDRACOLoader(dracoLoader);
            } catch (e) {
                utils.warn('DracoåŠ è½½å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æ™®é€šåŠ è½½:', e);
            }

            updateStatus("æ­£åœ¨åŠ è½½3Dæ¨¡å‹...");

            loader.load(
                url,
                (gltf) => {
                    // æ¸…ç†æ—§æ¨¡å‹å’ŒåŠ¨ç”»
                    if (currentModel) {
                        scene.remove(currentModel);
                    }
                    if (mixer) {
                        mixer.stopAllAction();
                        mixer = null;
                    }

                    // æ·»åŠ æ–°æ¨¡å‹
                    currentModel = gltf.scene;
                    
                    // è‡ªåŠ¨ç¼©æ”¾
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    if (maxDim > 0) {
                        const scale = 1 / maxDim;
                        currentModel.scale.setScalar(scale);
                    }

                    // æ·»åŠ åˆ°åœºæ™¯
                    if (mindarThree) {
                        // ARæ¨¡å¼ï¼šæ·»åŠ åˆ°é”šç‚¹
                        const anchor = mindarThree.addAnchor(0);
                        anchor.group.add(currentModel);
                    } else {
                        // æµ‹è¯•æ¨¡å¼ï¼šç›´æ¥æ·»åŠ åˆ°åœºæ™¯
                        scene.add(currentModel);
                    }

                    // æ’­æ”¾åŠ¨ç”»ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (gltf.animations?.length > 0) {
                        mixer = new THREE.AnimationMixer(currentModel);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }

                    updateStatus("æ¨¡å‹åŠ è½½æˆåŠŸ");
                    setTimeout(() => hideStatus(), 1000);
                },
                (progress) => {
                    if (progress.lengthComputable) {
                        const percent = ((progress.loaded / progress.total) * 100).toFixed(0);
                        updateStatus(`æ­£åœ¨åŠ è½½æ¨¡å‹: ${percent}%`);
                    }
                },
                (error) => {
                    utils.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    updateStatus("æ¨¡å‹åŠ è½½å¤±è´¥: " + (error.message || 'æœªçŸ¥é”™è¯¯'));
                    setTimeout(() => hideStatus(), 3000);
                }
            );
        }

        // ========== æ˜¾ç¤ºæ–‡ç‰©ä¿¡æ¯å¡ç‰‡ ==========
        function showArtifactCard(artifact) {
            const card = document.getElementById('artifactCard');
            if (!card) return;
            
            const nameEl = document.getElementById('artifactName');
            const dynastyEl = document.getElementById('artifactDynasty');
            const descEl = document.getElementById('artifactDescription');
            const thumbEl = document.getElementById('artifactThumbnail');
            
            if (nameEl) nameEl.textContent = artifact.name || 'æœªçŸ¥æ–‡ç‰©';
            if (dynastyEl) dynastyEl.textContent = artifact.dynasty || 'æœªçŸ¥æœä»£';
            if (descEl) descEl.textContent = artifact.description || 'æš‚æ— æè¿°';
            if (thumbEl) thumbEl.src = artifact.thumbnailUrl || 'https://via.placeholder.com/200';

            // å¡«å……è¯¦ç»†ä¿¡æ¯
            const details = document.getElementById('artifactDetails');
            if (details) {
                details.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">æè´¨</span>
                        <span class="detail-value">${artifact.material || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å°ºå¯¸</span>
                        <span class="detail-value">${artifact.size || 'æœªçŸ¥'}</span>
                    </div>
                `;
            }

            card.classList.add('active');
            
            // æ›´æ–°æ¨¡å‹èœå•ä¸­çš„é€‰ä¸­çŠ¶æ€
            updateModelMenuSelection(artifact.id);
        }

        function hideArtifactCard() {
            const card = document.getElementById('artifactCard');
            if (card) {
                card.classList.remove('active');
            }
        }

        // ========== æ¨¡å‹èœå•åŠŸèƒ½ ==========
        function toggleModelMenu() {
            const menu = document.getElementById('modelMenu');
            const btn = document.getElementById('modelMenuBtn');
            
            if (!menu || !btn) return;
            
            const isActive = menu.classList.contains('active');
            menu.classList.toggle('active', !isActive);
            btn.classList.toggle('hidden', !isActive);
        }

        function renderModelMenu() {
            const menuList = document.getElementById('modelMenuList');
            if (!menuList || !artifacts.length) return;
            
            menuList.innerHTML = '';
            
            artifacts.forEach(artifact => {
                const item = document.createElement('div');
                item.className = 'model-menu-item';
                item.dataset.artifactId = artifact.id;
                
                item.innerHTML = `
                    <img class="model-menu-thumbnail" 
                         src="${artifact.thumbnailUrl || 'https://via.placeholder.com/200'}" 
                         alt="${artifact.name}"
                         onerror="this.src='https://via.placeholder.com/200'">
                    <div class="model-menu-info">
                        <div class="model-menu-name">${artifact.name || 'æœªçŸ¥æ–‡ç‰©'}</div>
                        <div class="model-menu-dynasty">${artifact.dynasty || 'æœªçŸ¥æœä»£'}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    loadArtifact(artifact);
                    if (!mindarThree) {
                        // æµ‹è¯•æ¨¡å¼ä¸‹ç›´æ¥åŠ è½½
                        if (!scene) {
                            initTestMode();
                        }
                    }
                });
                
                menuList.appendChild(item);
            });
        }

        function updateModelMenuSelection(artifactId) {
            const items = document.querySelectorAll('.model-menu-item');
            items.forEach(item => {
                if (item.dataset.artifactId == artifactId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ========== çŠ¶æ€æç¤º ==========
        function updateStatus(text) {
            if (elements.statusText) {
                elements.statusText.textContent = text;
            }
            if (elements.statusOverlay) {
                elements.statusOverlay.classList.add('active');
            }
        }

        function hideStatus() {
            if (elements.statusOverlay) {
                elements.statusOverlay.classList.remove('active');
            }
        }

        // ========== AIèŠå¤©åŠŸèƒ½ ==========
        function toggleChat() {
            const panel = elements.chatPanel;
            const toggle = elements.chatToggle;
            
            if (!panel || !toggle) return;
            
            const isActive = panel.classList.contains('active');
            panel.classList.toggle('active', !isActive);
            toggle.classList.toggle('hidden', !isActive);
        }

        async function sendMessage() {
            if (isLoading) return;
            
            const input = elements.chatInput;
            const sendBtn = elements.chatSend;
            const message = input?.value.trim();
            
            if (!message) return;

            // æ£€æŸ¥APIé…ç½®
            if (!apiConfig.url || !apiConfig.key || !apiConfig.appId) {
                addChatMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIä¿¡æ¯', 'bot');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addChatMessage(message, 'user');
            if (input) input.value = '';
            
            // ç¦ç”¨è¾“å…¥
            isLoading = true;
            if (sendBtn) sendBtn.disabled = true;
            if (input) input.disabled = true;

            // æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å½“å‰æ–‡ç‰©ä¿¡æ¯ï¼‰
            let context = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç‰©çŸ¥è¯†åŠ©æ‰‹ã€‚";
            if (currentArtifact) {
                context += `å½“å‰ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹çš„æ–‡ç‰©æ˜¯ï¼š${currentArtifact.name}ï¼ˆ${currentArtifact.dynasty}ï¼‰ã€‚`;
                context += `æ–‡ç‰©ç®€ä»‹ï¼š${currentArtifact.description}ã€‚`;
            }
            context += `è¯·å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼š${message}`;

            // è°ƒç”¨API
            try {
                const response = await fetch(apiConfig.url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiConfig.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        input: { prompt: context },
                        parameters: {}
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                let answer = "æŠ±æ­‰ï¼Œæ— æ³•è§£æAPIå“åº”";
                
                if (result.output?.text) {
                    answer = result.output.text;
                } else if (result.choices?.[0]?.message?.content) {
                    answer = result.choices[0].message.content;
                } else if (result.response) {
                    answer = result.response;
                }

                addChatMessage(answer, 'bot');
            } catch (error) {
                utils.error('APIè°ƒç”¨å¤±è´¥:', error);
                addChatMessage(`æŠ±æ­‰ï¼Œå‘ç”Ÿé”™è¯¯: ${error.message}`, 'bot');
            } finally {
                // æ¢å¤è¾“å…¥
                isLoading = false;
                if (sendBtn) sendBtn.disabled = false;
                if (input) {
                    input.disabled = false;
                    input.focus();
                }
            }
        }

        function addChatMessage(text, sender) {
            const messages = elements.chatMessages;
            if (!messages) return;
            
            const message = document.createElement('div');
            message.className = `message message-${sender}`;
            message.textContent = text;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }

        // ========== åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ==========
        function initEventListeners() {
            // ç¼“å­˜DOMå…ƒç´ 
            const chatToggle = elements.chatToggle;
            const chatClose = document.getElementById('chatClose');
            const chatSend = elements.chatSend;
            const chatInput = elements.chatInput;
            const collectionBtn = document.getElementById('collectionBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            const arModeBtn = document.getElementById('arModeBtn');
            const expandBtn = document.getElementById('expandBtn');
            const modelMenuBtn = document.getElementById('modelMenuBtn');
            const modelMenuClose = document.getElementById('modelMenuClose');

            if (chatToggle) {
                chatToggle.addEventListener('click', toggleChat);
            }
            
            if (chatClose) {
                chatClose.addEventListener('click', toggleChat);
            }
            
            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // å¯¼èˆªæŒ‰é’®
            if (collectionBtn) {
                collectionBtn.addEventListener('click', () => {
                    if (artifacts.length > 0) {
                        // æ˜¾ç¤ºæ–‡ç‰©åˆ—è¡¨
                        let list = 'å¯ç”¨æ–‡ç‰©ï¼š\n\n';
                        artifacts.forEach((art, index) => {
                            list += `${index + 1}. ${art.name} (${art.dynasty})\n`;
                        });
                        list += '\nç‚¹å‡»"æµ‹è¯•æ¨¡å¼"æŒ‰é’®å¯ä»¥ç›´æ¥åŠ è½½æ¨¡å‹è¿›è¡Œæµ‹è¯•';
                        alert(list);
                    } else {
                        alert('æ–‡ç‰©åº“åŠŸèƒ½å¼€å‘ä¸­...');
                    }
                });
            }

            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    // åŠ è½½ä¿å­˜çš„é…ç½®
                    const saved = localStorage.getItem('arApiConfig');
                    if (saved) {
                        try {
                            apiConfig = JSON.parse(saved);
                        } catch (e) {
                            console.error('é…ç½®è§£æå¤±è´¥', e);
                        }
                    }
                    
                    const url = prompt('APIåœ°å€:', apiConfig.url || '');
                    const key = prompt('APIå¯†é’¥:', apiConfig.key || '');
                    const appId = prompt('åº”ç”¨ID:', apiConfig.appId || '');
                    
                    if (url && key && appId) {
                        apiConfig = { url, key, appId };
                        localStorage.setItem('arApiConfig', JSON.stringify(apiConfig));
                        alert('é…ç½®å·²ä¿å­˜');
                    }
                });
            }

            if (arModeBtn) {
                arModeBtn.addEventListener('click', () => {
                    // åˆ‡æ¢ARæ¨¡å¼å’Œæµ‹è¯•æ¨¡å¼
                    if (mindarThree) {
                        alert('å½“å‰ä¸ºARæ¨¡å¼ï¼Œå¦‚éœ€æµ‹è¯•æ¨¡å¼è¯·åˆ·æ–°é¡µé¢');
                    } else {
                        initTestMode();
                    }
                });
            }

            if (expandBtn) {
                expandBtn.addEventListener('click', () => {
                    if (currentArtifact) {
                        let detail = `\n${currentArtifact.name}\n\n`;
                        detail += `æœä»£ï¼š${currentArtifact.dynasty}\n`;
                        detail += `æè´¨ï¼š${currentArtifact.material}\n`;
                        detail += `å°ºå¯¸ï¼š${currentArtifact.size}\n\n`;
                        if (currentArtifact.history) {
                            detail += `å†å²èƒŒæ™¯ï¼š\n${currentArtifact.history}\n\n`;
                        }
                        if (currentArtifact.craftsmanship) {
                            detail += `åˆ¶ä½œå·¥è‰ºï¼š\n${currentArtifact.craftsmanship}\n\n`;
                        }
                        if (currentArtifact.culturalValue) {
                            detail += `æ–‡åŒ–ä»·å€¼ï¼š\n${currentArtifact.culturalValue}`;
                        }
                        alert(detail);
                    }
                });
            }

            // æ¨¡å‹èœå•æŒ‰é’®
            if (modelMenuBtn) {
                modelMenuBtn.addEventListener('click', toggleModelMenu);
            }

            if (modelMenuClose) {
                modelMenuClose.addEventListener('click', toggleModelMenu);
            }

            // æ·»åŠ æµ‹è¯•æ¨¡å¼æŒ‰é’®
            if (!document.getElementById('testModeBtn')) {
                const testBtn = document.createElement('button');
                testBtn.id = 'testModeBtn';
                testBtn.className = 'nav-btn';
                testBtn.textContent = 'æµ‹è¯•æ¨¡å¼';
                testBtn.style.marginLeft = '10px';
                testBtn.addEventListener('click', () => {
                    if (artifacts.length > 0) {
                        // ç›´æ¥åŠ è½½ç¬¬ä¸€ä¸ªæ–‡ç‰©è¿›è¡Œæµ‹è¯•
                        if (!scene) {
                            initTestMode();
                        } else {
                            loadArtifact(artifacts[0]);
                        }
                    } else {
                        alert('è¯·å…ˆåŠ è½½é…ç½®æ–‡ä»¶');
                    }
                });
                const navButtons = document.querySelector('.nav-buttons');
                if (navButtons) {
                    navButtons.appendChild(testBtn);
                }
            }
        }

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // é¦–å…ˆåŠ è½½é…ç½®æ–‡ä»¶
            await loadConfig();
            
            // æ¸²æŸ“æ¨¡å‹èœå•
            renderModelMenu();
            
            // åŠ è½½ä¿å­˜çš„APIé…ç½®ï¼ˆlocalStorageä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ï¼‰
            const saved = localStorage.getItem('arApiConfig');
            if (saved) {
                try {
                    const savedConfig = JSON.parse(saved);
                    // åªæœ‰å½“localStorageä¸­æœ‰é…ç½®æ—¶æ‰è¦†ç›–
                    if (savedConfig.url && savedConfig.key && savedConfig.appId) {
                        apiConfig = savedConfig;
                        console.log('ä½¿ç”¨localStorageä¸­çš„APIé…ç½®');
                    } else {
                        utils.log('ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„APIé…ç½®');
                    }
                } catch (e) {
                    utils.warn('localStorageé…ç½®è§£æå¤±è´¥ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶', e);
                }
            } else {
                utils.log('ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„APIé…ç½®');
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰è¯†åˆ«å›¾æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æµ‹è¯•æ¨¡å¼
            try {
                const response = await fetch('targets/targets.mind', { method: 'HEAD' });
                if (response.ok) {
                    // æœ‰è¯†åˆ«å›¾ï¼Œåˆå§‹åŒ–AR
                    initAR();
                } else {
                    // æ²¡æœ‰è¯†åˆ«å›¾ï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼
                    utils.log('æœªæ‰¾åˆ°è¯†åˆ«å›¾æ–‡ä»¶ï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼');
                    updateStatus("æœªæ‰¾åˆ°è¯†åˆ«å›¾ï¼Œåˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼...");
                    setTimeout(() => initTestMode(), 1000);
                }
            } catch (error) {
                // æ— æ³•è®¿é—®è¯†åˆ«å›¾ï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼
                utils.log('æ— æ³•è®¿é—®è¯†åˆ«å›¾æ–‡ä»¶ï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼:', error);
                updateStatus("æ— æ³•è®¿é—®è¯†åˆ«å›¾ï¼Œåˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼...");
                setTimeout(() => initTestMode(), 1000);
            }
        });
    </script>
</body>
</html>


